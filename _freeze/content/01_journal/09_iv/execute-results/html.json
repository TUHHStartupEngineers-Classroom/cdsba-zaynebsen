{
  "hash": "5b6f5b00213959c4e04beba08c6cff4f",
  "result": {
    "markdown": "---\ntitle: \"Instrumental Variables\"\n---\n\n::: {.cell hash='09_iv_cache/html/unnamed-chunk-1_a163ac5579c6ebdb7f4f9c830e579e3d'}\n\n```{.r .cell-code}\nlibrary(dagitty)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: le package 'dagitty' a été compilé avec la version R 4.3.2\n```\n:::\n\n```{.r .cell-code}\nlibrary(ggdag)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: le package 'ggdag' a été compilé avec la version R 4.3.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> \n#> Attachement du package : 'ggdag'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> L'objet suivant est masqué depuis 'package:stats':\n#> \n#>     filter\n```\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: le package 'ggplot2' a été compilé avec la version R 4.3.2\n```\n:::\n\n```{.r .cell-code}\nmodel<- dagify(\n  Y ~ D,\n  Y ~ U,\n  D ~ U,\n  D ~ Z,\n  exposure = \"D\",\n  latent = \"U\",\n  outcome = \"Y\",\n  coords = list(x = c(U = 1, D = 0, Y = 2, Z = -1),\n                y = c(U = 1, D = 0, Y = 0, Z = 0)),\n  labels = c(\"D\" = \"Usage of new feature\", \n             \"Y\" = \"Time spent\", \n             \"U\" = \"willingness\",\n             \"Z\" = \"EncouragementU\")\n)\nggdag(model, text = T) +\n  guides(color = \"none\") +\n  geom_dag_text(color = \"white\") +\n  geom_dag_edges(edge_color = \"black\") +\n  geom_dag_label_repel(aes(label = label))\n```\n\n::: {.cell-output-display}\n![](09_iv_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='09_iv_cache/html/unnamed-chunk-2_5e6d5793ba8aaf9d1cc7de10f9aacdb0'}\n\n```{.r .cell-code}\nrand_enc <- readRDS(\"rand_enc.rds\")\n\nmodel_biased <- lm(time_spent ~ used_ftr, data = rand_enc)\nsummary(model_biased)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = time_spent ~ used_ftr, data = rand_enc)\n#> \n#> Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -20.4950  -3.5393   0.0158   3.5961  20.5051 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept) 18.86993    0.06955   271.3   <2e-16 ***\n#> used_ftr    10.82269    0.10888    99.4   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 5.351 on 9998 degrees of freedom\n#> Multiple R-squared:  0.497,\tAdjusted R-squared:  0.497 \n#> F-statistic:  9881 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n---\n1- Stable unit treatment value assumption: Potential outcomes (time spent onf the app) for a user do not vary with treatments (usage of the new feature) assigned to other users.\n2- Independence assumption: There is no confounding between instrument(encouragement) and treatment (usage of the new feature) and also no confounding between the instrument and the outcome.it means there is no factor that both influences the encouragement and usage of the feature or the time spent. If we want to think of a potential violation, we could imagine more motivated users receiving the encouragement pop up  and thus, there would be confounding between the encouragement and both treatment assignment and outcome.\n3- Exclusion restriction:  the instrument does not directly affect outcome, but only through the treatment. There is no obvious reason why receiving the encouragement pop up would affect the time spent by a user.\n---\n\n::: {.cell hash='09_iv_cache/html/unnamed-chunk-3_72048d51752397fab438d7582e7708ea'}\n\n```{.r .cell-code}\ncor(rand_enc) %>% round(2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#>            rand_enc used_ftr time_spent\n#> rand_enc       1.00     0.20       0.13\n#> used_ftr       0.20     1.00       0.71\n#> time_spent     0.13     0.71       1.00\n```\n:::\n\n```{.r .cell-code}\nsummary( lm(used_ftr ~ rand_enc, data = rand_enc))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = used_ftr ~ rand_enc, data = rand_enc)\n#> \n#> Residuals:\n#>     Min      1Q  Median      3Q     Max \n#> -0.5071 -0.3062 -0.3062  0.4929  0.6938 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept) 0.306164   0.006851   44.69   <2e-16 ***\n#> rand_enc    0.200940   0.009624   20.88   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 0.4811 on 9998 degrees of freedom\n#> Multiple R-squared:  0.04178,\tAdjusted R-squared:  0.04169 \n#> F-statistic:   436 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\nsummary(lm(time_spent~used_ftr, data= rand_enc ))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = time_spent ~ used_ftr, data = rand_enc)\n#> \n#> Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -20.4950  -3.5393   0.0158   3.5961  20.5051 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept) 18.86993    0.06955   271.3   <2e-16 ***\n#> used_ftr    10.82269    0.10888    99.4   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 5.351 on 9998 degrees of freedom\n#> Multiple R-squared:  0.497,\tAdjusted R-squared:  0.497 \n#> F-statistic:  9881 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n::: {.cell hash='09_iv_cache/html/unnamed-chunk-4_594fd9ee23cd6e303bac2f9364f7acf2'}\n\n```{.r .cell-code}\nlibrary(tibble)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: le package 'tibble' a été compilé avec la version R 4.3.2\n```\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\nfirst_stage <- lm(used_ftr ~ rand_enc, data = rand_enc)\nsummary(first_stage)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = used_ftr ~ rand_enc, data = rand_enc)\n#> \n#> Residuals:\n#>     Min      1Q  Median      3Q     Max \n#> -0.5071 -0.3062 -0.3062  0.4929  0.6938 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept) 0.306164   0.006851   44.69   <2e-16 ***\n#> rand_enc    0.200940   0.009624   20.88   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 0.4811 on 9998 degrees of freedom\n#> Multiple R-squared:  0.04178,\tAdjusted R-squared:  0.04169 \n#> F-statistic:   436 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\npred_fs <- predict(first_stage)\npred_vs_actl <- tibble(\n  pred = pred_fs,\n  actl = rand_enc$used_ftr\n)\nggplot(pred_vs_actl, aes(x = pred, y = actl, color = as.factor(actl))) +\n  geom_jitter(alpha = .5) +\n  scale_color_discrete(labels = c(\"Control Group\", \"Treatment Group\")) +\n    theme(legend.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](09_iv_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\nsecond_stage <- lm(rand_enc$time_spent ~ first_stage$fitted.values)\nsummary(second_stage)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = rand_enc$time_spent ~ first_stage$fitted.values)\n#> \n#> Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -25.8757  -5.4714  -0.3263   5.3807  25.6541 \n#> \n#> Coefficients:\n#>                           Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)                19.3124     0.3129   61.72   <2e-16 ***\n#> first_stage$fitted.values   9.7382     0.7447   13.08   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 7.482 on 9998 degrees of freedom\n#> Multiple R-squared:  0.01681,\tAdjusted R-squared:  0.01672 \n#> F-statistic:   171 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\nlibrary(estimatr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: le package 'estimatr' a été compilé avec la version R 4.3.2\n```\n:::\n\n```{.r .cell-code}\nmodel_iv <- iv_robust(time_spent ~ used_ftr | rand_enc, data = rand_enc)\nsummary(model_iv)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> iv_robust(formula = time_spent ~ used_ftr | rand_enc, data = rand_enc)\n#> \n#> Standard error type:  HC2 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value  Pr(>|t|) CI Lower CI Upper   DF\n#> (Intercept)   19.312     0.2248   85.89 0.000e+00   18.872    19.75 9998\n#> used_ftr       9.738     0.5353   18.19 8.716e-73    8.689    10.79 9998\n#> \n#> Multiple R-squared:  0.4921 ,\tAdjusted R-squared:  0.492 \n#> F-statistic:   331 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}